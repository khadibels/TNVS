name: CI → Test → Build → Deploy (diagnostic)

on:
  push:
    branches: [ "staging", "main" ]
  workflow_dispatch: {}

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer, phpunit

      - name: Install Composer deps (prod for main, dev for staging)
        run: |
          if [ -f composer.json ]; then
            if [ "${{ github.ref_name }}" = "main" ]; then
              composer install --no-dev --no-interaction --no-progress --prefer-dist
            else
              composer install --no-interaction --no-progress --prefer-dist
            fi
          else
            echo "No composer.json, skipping composer."
          fi

      - name: PHP syntax check
        run: |
          mapfile -t FILES < <(find . -type f -name "*.php")
          if [ ${#FILES[@]} -gt 0 ]; then
            for f in "${FILES[@]}"; do php -l "$f"; done
          else
            echo "No PHP files found to lint."
          fi

      - name: Run PHPUnit (if phpunit.xml exists)
        run: |
          if [ -f phpunit.xml ] || [ -f phpunit.xml.dist ]; then
            vendor/bin/phpunit --colors=always
          else
            echo "No phpunit config, skipping tests."
          fi

      # Optional Node build steps omitted here… (keep yours if needed)

      # ---- Marker so we can see it on the server ----
      - name: Add deploy marker
        run: echo "Deployed $(date -u +'%Y-%m-%d %H:%M:%S UTC') @ $GITHUB_SHA" > __DEPLOYED__.txt

      # ---- Package artifact (robust tar) ----
      - name: Archive build artifact
        run: |
          tar --warning=no-file-changed --ignore-failed-read -czf site.tar.gz \
            --exclude='./.git' \
            --exclude='./.github' \
            --exclude='./node_modules' \
            --exclude='./tests' \
            --exclude='./README.md' \
            --exclude='./composer.lock' \
            --exclude='./package*.json' \
            --exclude='./site.tar.gz' \
            .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: site
          path: site.tar.gz
          retention-days: 3

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_test
    if: ${{ success() }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: site

      - name: Extract
        run: tar -xzf site.tar.gz

      - name: Set target directory
        id: paths
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "dir=/home/logistics1.viahale.com/public_html/" >> $GITHUB_OUTPUT
          else
            echo "dir=/home/logistics1.viahale.com/staging/" >> $GITHUB_OUTPUT
          fi
          echo "Using server-dir: $(cat $GITHUB_OUTPUT)"

      - name: Deploy via FTPS (force clean ONCE)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server:   ${{ secrets.FTP_SERVER }}      # 23.94.230.146
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port:     21
          protocol: ftps
          security: loose
          timeout: 60000
          local-dir: ./ 
          server-dir: ${{ steps.paths.outputs.dir }}
          dangerous-clean-slate: true              # <— ONE RUN ONLY
          exclude: |
            **/.git**
            **/.github/**
            **/node_modules/**
            **/tests/**
            .env
            README.md
            composer.lock
            package*.json
